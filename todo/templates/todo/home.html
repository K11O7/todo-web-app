{% extends 'todo/base.html' %}
{% load form_tags %}

{% block title %}Todo List{% endblock %}

{% block content %}
<div class="container py-5 pb-5">
  <div class="d-flex flex-sm-row justify-content-between align-items-start align-items-sm-center gap-2 mb-4">
    <h1>üìã Todo List</h1>
    <div class="d-flex align-items-center">
      {% if request.user.is_authenticated %}
  <span class="me-2">Hi, <strong>{{ request.user.username }}</strong></span>
  <a href="{% url 'logout' %}" class="btn btn-sm btn-danger">Logout</a>
{% else %}
  <a href="{% url 'login' %}" class="btn btn-sm btn-outline-primary me-2">Login</a>
  <a href="{% url 'signup' %}" class="btn btn-sm btn-outline-success">Sign Up</a>
{% endif %}
      <button class="btn btn-outline-secondary btn-sm me-2 ms-2" id="darkModeToggle">üåô</button>
    </div>
  </div>
  {% if is_guest %}
<div class="alert alert-warning alert-dismissible fade show d-flex align-items-center" role="alert">
  ‚ö†Ô∏è <span class="ms-2">You're in guest mode. Your tasks won't be saved permanently. <a href="{% url 'login' %}">Log in</a> or <a href="{% url 'signup' %}">Sign Up</a>.</span>
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
  {% endif %}
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <form method="POST" class="row g-2">
        {% csrf_token %}
        <div class="col-md-8">
          {{ form.title.label_tag }}
          {{ form.title }}
        </div>
        <div class="col-md-2">
          {{ form.due_date.label_tag }}
          {{ form.due_date }}
        </div>
        <div class="col-md-2">
          {{ form.priority.label_tag }}
          {{ form.priority }}
        </div>
        <div class="col-12">
          <button type="submit" class="btn btn-primary w-100">‚úö Add Task</button>
        </div>
      </form>
    </div>
  </div>

  <div class="mb-3 d-flex flex-wrap gap-2 align-items-center">
    <a href="?filter=all" class="btn btn-outline-primary btn-sm {% if filter == 'all' %}active{% endif %}">üìã All</a>
    <a href="?filter=completed" class="btn btn-outline-success btn-sm {% if filter == 'completed' %}active{% endif %}">‚úÖ Completed</a>
    <a href="?filter=pending" class="btn btn-outline-warning btn-sm {% if filter == 'pending' %}active{% endif %}">üïì Pending</a>
    <span class="text-muted ms-3 mt-0.5">Showing {{ todos|length }} task{{ todos|length|pluralize }} ({{ filter|capfirst }})</span>
  </div>

  <ul class="list-group shadow-sm">
    {% for todo in todos %}
  <li id="todo-{{ todo.id }}" class="list-group-item d-flex justify-content-between align-items-center todo-item">
    <span>
      {% if todo.priority == 'H' or todo.priority == 'High' %}
        <span class="badge bg-danger me-1">High</span>
      {% elif todo.priority == 'M' or todo.priority == 'Medium' %}
        <span class="badge bg-warning text-dark me-1">Medium</span>
      {% elif todo.priority == 'L' or todo.priority == 'Low' %}
        <span class="badge bg-success me-1">Low</span>
      {% endif %}

      {{ todo.title }}

      {% if todo.due_date %}
        <small class="text-muted">| Due: {{ todo.due_date }}</small>
        {% if not todo.completed %}
          {% now "Y-m-d" as today_date %}
          {% with due_date=todo.due_date|stringformat:"s" %}
            {% if due_date < today_date %}
              <span class="badge bg-danger due-badge">Overdue</span>
            {% elif due_date == today_date %}
              <span class="badge bg-info text-dark due-badge">Today</span>
            {% else %}
              <span class="badge bg-success due-badge">Upcoming</span>
            {% endif %}
          {% endwith %}
        {% endif %}
      {% else %}
        <span class="badge bg-secondary due-badge">No Due Date</span>
      {% endif %}

      {% if todo.completed %}
        <span class="badge bg-success status-badge">Done</span>
      {% else %}
        <span class="badge bg-warning status-badge text-dark">Pending</span>
      {% endif %}
    </span>

    {% if request.user.is_authenticated %}
    <span class="d-flex flex-wrap gap-2 justify-content-end mt-2 mt-md-0">
      <a class="btn btn-sm btn-outline-success toggle-btn" data-id="{{ todo.id }}" aria-label="Toggle completion">
        {% if todo.completed %}‚Ü©Ô∏è{% else %}‚úÖ{% endif %}
      </a>
      <a href="{% url 'edit' todo.id %}" class="btn btn-sm btn-outline-primary ms-0.5">‚úèÔ∏è</a>
      <a href="{% url 'delete' todo.id %}" class="btn btn-sm btn-outline-danger ms-0.5" onclick="return confirm('Are you sure you want to delete this task?');">üóëÔ∏è</a>
    </span>
    {% endif %}
  </li>
{% empty %}
  <li class="list-group-item">No todos found.</li>
{% endfor %}

  </ul>
</div>
{% endblock %}

{% block script %}
<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      cookie = cookie.trim();
      if (cookie.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.toggle-btn').forEach(btn => {
    btn.addEventListener('click', function () {
      const todoId = this.dataset.id;
      fetch(`/toggle/${todoId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'Content-Type': 'application/json'
        },
      })
      .then(res => res.json())
      .then(data => {
        const todoItem = document.querySelector(`#todo-${data.id}`);
        const status = todoItem.querySelector('.status-badge');
        const dueBadge = todoItem.querySelector('.due-badge');

        if (data.completed) {
          status.textContent = 'Done';
          status.className = 'badge bg-success status-badge';
          if (dueBadge) {
            dueBadge.style.display = 'none';
          }
        } else {
          status.textContent = 'Pending';
          status.className = 'badge bg-warning text-dark status-badge';
            if (dueBadge) {
              dueBadge.style.display = 'inline-block';
            }
        }
          const toggleBtn = todoItem.querySelector('.toggle-btn');
          toggleBtn.textContent = data.completed ? '‚Ü©Ô∏è' : '‚úÖ';
      });
    });
  });
});
</script>
{{ block.super }}
{% endblock %}
